CREATE procedure sp_ssrs_LinkTypeCountPerPhysician(	@Database nvarchar(200),	@Matched int)as/*declare@Database nvarchar(200),@Matched intset @Database = 'Competition_B'set @Matched = 0exec sp_ssrs_LinkTypeCountPerPhysician @Database, @Matched*/declare@sql nvarchar(max),@parms nvarchar(max),@CR char(1)set @CR = char(13) set @sql = 'select isnull(id.CustomerSource, v.FirstName) as [System], v.NPI, v.FirstName, v.LastName, count(v.LinkTarget) as LinkCount, v.LinkType ' + @CRset @sql = @sql + 'from ' + @Database + '.dbo.vw_PhysicianSearch v ' + @CRset @sql = @sql + 'left join ' + @Database + '.dbo.PhysCustomerID id ' + @CRset @sql = @sql + 'on id.NPI = v.NPI ' + @CRset @sql = @sql + 'where v.LinkType is not null ' + @CRset @sql = @sql + 'and v.Status = ''Active'' ' + @CRset @sql = @sql + 'and (v.LinkType in (''Rating'',''Personal'') ' + @CRset @sql = @sql + 'or v.LinkType like ''Social -%'' ' + @CRset @sql = @sql + 'or v.LinkType like ''%- Directory'' ' + @CRset @sql = @sql + 'or v.LinkType like ''%- Profile'') ' + @CRif @Matched = 1begin	set @sql = @sql + 'and v.MatchRank > 0 ' + @CRendset @sql = @sql + 'group by id.CustomerSource, v.NPI, v.FirstName, v.LastName, v.LinkType ' + @CRset @sql = @sql + 'order by [System], LastName, FirstName, LinkCount desc ' + @CRexec(@sql)
