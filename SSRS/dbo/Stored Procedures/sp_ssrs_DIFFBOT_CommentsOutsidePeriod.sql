CREATE procedure sp_ssrs_DIFFBOT_CommentsOutsidePeriod (@TrendPeriod nvarchar(50))as/*declare @TrendPeriod nvarchar(50) = '_CURRENT_'exec sp_ssrs_DIFFBOT_CommentsOutsidePeriod @TrendPeriod*/declare@Database nvarchar(200),@sql nvarchar(max),@parms nvarchar(max),@CR char(1)set @CR = char(13)if @TrendPeriod = '_CURRENT_'begin	select top 1 @TrendPeriod = StartDate + ' - ' + EndDate from Rothman.dbo.PhysVRepTrendMedia order by EndBatchID descend/*set @sql = ' ' + @CRset @sql = @sql + ' ' + @CRexec(@sql)*/create table #dbs(ID int identity, DbName nvarchar(200))insert		#dbsselect		SystemDatabase
from		MDVALUATE.dbo.SystemRecordsMedia
where		IsClient = 'Yes'order by	SystemDatabasecreate table #rep_trend(	NPITrend nvarchar(100),	SystemID nvarchar(10),	SystemName nvarchar(400),	SiteName nvarchar(50),	NPI nvarchar(10),	FirstName nvarchar(200),	LastName nvarchar(200),	CommentDate datetime,	CommentText nvarchar(max),	IsNegative int,	RecordType int)declare @counter int = 1while @counter <= (select max(ID) from #dbs)begin	select @Database = DbName from #dbs where ID = @counter	set @sql = 'insert #rep_trend ' + @CR	set @sql = @sql + 'select media.NPITrend, media.SystemID, media.SystemName, comment.RepCommentSite, ' + @CR	set @sql = @sql + 'media.NPI, media.FirstName, media.LastName, comment.RepCommentDate, ' + @CR	set @sql = @sql + 'comment.RepCommentText, comment.RepCommentIsNegative, ' + @CR	set @sql = @sql + 'case when media.LastName = ''System'' then 0 ' + @CR	set @sql = @sql + 'when media.LastName = ''Specialty'' then 1  ' + @CR	set @sql = @sql + 'when media.LastName = ''Group'' then 2  ' + @CR	set @sql = @sql + 'else 3 end  ' + @CR	set @sql = @sql + 'from ' + @Database + '.dbo.PhysVRepTrendMedia media ' + @CR	set @sql = @sql + 'inner join ' + @Database + '.dbo.VIRepComment comment ' + @CR	set @sql = @sql + 'on comment.NPITrend = media.NPITrend ' + @CR	set @sql = @sql + 'where media.StartDate + '' - '' + media.EndDate = ''' + @TrendPeriod + ''' ' + @CR	set @sql = @sql + 'and comment.RepCommentDate < media.StartDate ' + @CR	exec(@sql)	set @counter = @counter + 1endselect		*from		#rep_trendorder by	SystemName, SiteName, RecordType, LastName, FirstName
drop table #dbs
drop table #rep_trend